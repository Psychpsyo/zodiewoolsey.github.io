<!DOCTYPE html>
<html>
    <head>
        <style>
            .box{
                background-color: #095;
                margin: 0px;
                padding: 0px;
                border: 1pt solid black;
                transition:all .2s;
                z-index: 1;
                max-width: 6vh;
            }
            .box.cursor{
                background-color: #8ee;
            }
            .b {
                background-color: #f00;
            }
            .box.b.cursor{
                background-color: #f88;
            }
            #gameContainer{
                display: flex;
            }
            body{
                overflow: hidden;
                background-color: black;
            }
            html{
                user-select: none;
                color: white;
                font-family: sans-serif;
            }
        </style>
    </head>
    <body style="width: 100vw; height: 100vh; margin: 0px; padding: 0px;">
        <div class="buttons" style="position: absolute;">
            <div>
                <input placeholder="Paste pattern code here!" id="inputCode">
                <div id="enterCode">Enter a pattern code</div>
            </div>
            <div>
                <div id="toggleEditMode">Toggle pattern edit mode</div>
            </div>
            <div>
                <div id="codeGen">Generate pattern code</div>
                <div style="user-select:text !important;">Code: <div id="code" style="max-width: 20vw; word-wrap: break-word;"></div></div>
            </div>
        </div>
        <div style="margin-left: auto; margin-right: auto; padding: 0px; width: min-content">
            <div style="text-align: center; font-size: 5vw;" id="level"></div>
            <div id="gameContainer"></div>
        </div>
    </body>
    <script>

        let isClick = false;
        let level = 0;
        let prevTouchElem = '';
        let patternEditMode = false;

        document.addEventListener('mousedown',()=>{isClick = true;})
        document.addEventListener('mouseup',()=>{isClick = false;})
        document.addEventListener('touchend',()=>{isClick = false;})

        let gameContainer = document.querySelector('#gameContainer');
        //let dimension = [Math.floor(window.innerWidth/20) ,Math.floor(window.innerHeight/20)]
        let dimension = [10,10];

        let squares = [];
        for( i = 0; i < dimension[0]; i++ ){
            let tmpRow = document.createElement('div');
            tmpRow.classList.add('row');
            for(a = 0; a < dimension[1]; a++){
                let tmp = document.createElement('div');
                tmp.style.width = "9vw";
                tmp.style.paddingBottom = "100%";
                tmp.classList.add('box');
                tmp.setAttribute('pos',`${i},${a}`);
                tmp.addEventListener('mouseenter', (e)=>{e.target.classList.toggle('cursor');boxTouchActivate(e)} );
                tmp.addEventListener('touchmove', boxTouchActivate );
                tmp.addEventListener('mouseleave', (e)=>{e.target.classList.toggle('cursor');} );
                tmp.addEventListener('touchstart', (e)=>{e.preventDefault(); isClick=true;boxTouchActivate(e);} );
                tmp.addEventListener('mousedown', (e)=>{isClick = true;boxTouchActivate(e)} );
                tmpRow.appendChild(tmp);
            }
            gameContainer.appendChild(tmpRow);
        }

        let boxes = document.querySelectorAll('.box');

        function boxAcivate(e){
            let initialPos = e.target.getAttribute('pos');
            initialPos = initialPos.split(',');
            if(e.synthetic === true){
                if((initialPos[0] > 0 && initialPos[0] < dimension[0]-1) && ( initialPos[1] > 0 && initialPos[1] < dimension[1]-1 ) ){
                    let posCheck = [`${initialPos[0]-1},${initialPos[1]}`,
                        `${initialPos[0]-(-1)},${initialPos[1]}`,
                        `${initialPos[0]},${initialPos[1]-1}`,
                        `${initialPos[0]},${initialPos[1]-(-1)}`]
                        posCheck.forEach( (pos)=>{
                            document.querySelector(`[pos='${pos}']`).classList.toggle('b');
                        } );
                        e.target.classList.toggle('b');
                    if(document.querySelectorAll('.b').length == 0){
                        init();
                    }
                }
            }else{
                if(isClick && (initialPos[0] > 0 && initialPos[0] < dimension[0]-1) && ( initialPos[1] > 0 && initialPos[1] < dimension[1]-1 ) ){
                    let posCheck = [`${initialPos[0]-1},${initialPos[1]}`,
                        `${initialPos[0]-(-1)},${initialPos[1]}`,
                        `${initialPos[0]},${initialPos[1]-1}`,
                        `${initialPos[0]},${initialPos[1]-(-1)}`]
                        posCheck.forEach( (pos)=>{
                            document.querySelector(`[pos='${pos}']`).classList.toggle('b');
                        } );
                        e.target.classList.toggle('b');
                    if(document.querySelectorAll('.b').length == 0 && patternEditMode == false){
                        init();
                    }
                }
            }
        }

        function boxTouchActivate(e){
            tmp={};
            if(e.touches != undefined){
                tmp.target = document.elementFromPoint( e.touches[0].clientX,e.touches[0].clientY );
                if(tmp.target != prevTouchElem){
                    if(document.querySelector('.cursor') != undefined){
                        document.querySelector('.cursor').classList.toggle('cursor');
                    }
                    tmp.target.classList.toggle('cursor');
                    boxAcivate(tmp);
                    prevTouchElem = tmp.target;
                }
            }else{
                tmp.target = e.target;
                if(tmp.target != prevTouchElem && isClick == true){
                    boxAcivate(tmp);
                    prevTouchElem = tmp.target;
                }
            }
        }

        function synthBoxActivate(e){
            e.synthetic = true;
            boxAcivate(e);
        }

        function init(){
            level++;
            document.querySelector('#level').innerText = 'Level: '+level;
            for(i = 0; i < level; i++){
                let tmp = {};
                tmp.target = boxes[ Math.round(Math.random()*(dimension[0]*dimension[1]))];
                tmp.splitPos = tmp.target.getAttribute('pos').split(',');
                if(tmp.splitPos[0] == 0 || tmp.splitPos[0] == 9 || tmp.splitPos[1] == 0 || tmp.splitPos[1] == 9){
                    i--;
                }
                synthBoxActivate(tmp)
            }
        }

        function patternParser(patternString){
            if(patternString == undefined){
                let parsedPattern = '';
                document.querySelectorAll('.b').forEach( (e)=>{
                    parsedPattern += e.getAttribute('pos');
                    parsedPattern += ';';
                });
                
                return parsedPattern;
            }else if(patternString.includes(',') && patternString.includes(';')){
                clearPattern();
                patternString.split(';').forEach( (e)=>{
                    boxes.forEach( (a)=>{
                        if(a.getAttribute('pos') == e && !a.classList.contains('b')){
                            a.classList.toggle('b');
                        }
                    } )
                } )
            }
        }

        function clearPattern(){
            document.querySelectorAll('.b').forEach( (e)=>{
                    e.classList.toggle('b');
                } )
        }

        function parsedPatternMatcher(patternString){
            if( patternParser() == patternString ){
                console.log("It works!");
            }
        }

        

        function toggleEditMode(){
            if(patternEditMode === false){
                patternEditMode = true;
                document.querySelector('#level').innerText = "Pattern Edit Mode";
            if(document.querySelector('.cursor') != undefined){
                document.querySelector('.cursor').classList.toggle('cursor');
            }
            document.querySelectorAll('.b').forEach( (e)=>{
                e.classList.toggle('b');
            } )
            }else if(patternEditMode === true){
                patternEditMode = false;
                document.querySelectorAll('.b').forEach( (e)=>{
                    e.classList.toggle('b');
                } )
                level -= 1;
                init();
            }
        }


        document.querySelector('#codeGen').addEventListener('click', ()=>{document.querySelector('#code').innerText = (patternParser())});
        document.querySelector('#toggleEditMode').addEventListener('click', ()=>{toggleEditMode()} )
        document.querySelector('#enterCode').addEventListener('click', ()=>{patternParser(document.querySelector('#inputCode').value)} )

        init();
    </script>
</html>
